<meta http-equiv="Content-Type" content="text/html; charset=utf-8"><link type="text/css" rel="stylesheet" href="resources/sheet.css" >
<style type="text/css">.ritz .waffle a { color: inherit; }.ritz .waffle .s0{border-right:1px SOLID #000000;background-color:#ffffff;}.ritz .waffle .s1{border-bottom:1px SOLID #000000;border-right:1px SOLID #000000;background-color:#ffffff;text-align:left;font-weight:bold;color:#000000;font-family:Arial;font-size:10pt;vertical-align:bottom;white-space:nowrap;direction:ltr;padding:2px 3px 2px 3px;}.ritz .waffle .s2{border-bottom:1px SOLID #000000;border-right:1px SOLID #000000;background-color:#ffffff;text-align:left;font-weight:bold;color:#000000;font-family:Arial;font-size:10pt;vertical-align:middle;white-space:nowrap;direction:ltr;padding:2px 3px 2px 3px;}.ritz .waffle .s3{border-bottom:1px SOLID #000000;border-right:1px SOLID #000000;background-color:#ffffff;text-align:left;color:#000000;font-family:Arial;font-size:10pt;vertical-align:bottom;white-space:nowrap;direction:ltr;padding:2px 3px 2px 3px;}</style><div class="ritz grid-container" dir="ltr"><table class="waffle" cellspacing="0" cellpadding="0"><thead><tr><th class="row-header freezebar-origin-ltr"></th><th id="1808927785C0" style="width:100px;" class="column-headers-background">A</th><th id="1808927785C1" style="width:121px;" class="column-headers-background">B</th><th id="1808927785C2" style="width:976px;" class="column-headers-background">C</th></tr></thead><tbody><tr style="height: 20px"><th id="1808927785R0" style="height: 20px;" class="row-headers-background"><div class="row-header-wrapper" style="line-height: 20px">1</div></th><td class="s0"></td><td class="s1" dir="ltr">KPI Name</td><td class="s1" dir="ltr">SQL code</td></tr><tr style="height: 20px"><th id="1808927785R1" style="height: 20px;" class="row-headers-background"><div class="row-header-wrapper" style="line-height: 20px">2</div></th><td class="s0"></td><td class="s2" dir="ltr">Revenue</td><td class="s3" dir="ltr">WITH sessions_unique AS (<br>  SELECT DISTINCT<br>    session_id,<br>    traffic_source<br>  FROM `prism-acquire.prism_acquire.sessions`<br>),<br><br>session_revenue_by_month AS ( <br>  SELECT DISTINCT<br>    session_id,<br>    transaction_id,<br>    DATE(EXTRACT(YEAR FROM date), EXTRACT(MONTH FROM date), 1) AS month,<br>    SUM(transaction_revenue) AS session_revenue<br>  FROM `prism-acquire.prism_acquire.transactions`<br>  <br>  GROUP BY session_id, transaction_id, month<br>),<br><br>transaction_profit AS (<br>  SELECT<br>    txnitem.transaction_id,<br>    (txnitem.item_quantity * (txnitem.item_price - cost.cost_of_item)) AS item_profit<br>  FROM `prism-acquire.prism_acquire.transactionsanditems` AS txnitem<br>  <br>  JOIN `prism-acquire.prism_acquire.product_costs` AS cost<br>    ON txnitem.item_id = cost.item_id<br>),<br><br>session_profit AS (<br>  SELECT DISTINCT<br>    srev.session_id,<br>    srev.month,<br>    srev.session_revenue,<br>    SUM(txnprof.item_profit) AS total_profit<br>  FROM session_revenue_by_month AS srev<br>  <br>  JOIN transaction_profit AS txnprof<br>    ON srev.transaction_id = txnprof.transaction_id<br>  <br>  GROUP BY srev.session_id, srev.month, srev.session_revenue<br>),<br><br>session_profit_with_source AS (<br>  SELECT DISTINCT<br>    sprof.session_id,<br>    sprof.month,<br>    sprof.session_revenue,<br>    sprof.total_profit,<br>    session.traffic_source<br>  FROM session_profit AS sprof<br>  <br>  JOIN `prism-acquire.prism_acquire.sessions` AS session<br>    ON sprof.session_id = session.session_id<br>)<br><br>SELECT<br>  month,<br>  traffic_source,<br>  ROUND(SUM(session_revenue), 2) AS total_revenue,<br>  ROUND(SUM(total_profit), 2) AS total_profit,<br>  ROUND(SAFE_DIVIDE(SUM(total_profit), SUM(session_revenue)), 2) AS profit_margin<br>FROM session_profit_with_source<br><br>GROUP BY month, traffic_source<br>ORDER BY month, total_revenue DESC;</td></tr><tr style="height: 20px"><th id="1808927785R2" style="height: 20px;" class="row-headers-background"><div class="row-header-wrapper" style="line-height: 20px">3</div></th><td class="s0"></td><td class="s1"></td><td class="s3"></td></tr><tr style="height: 20px"><th id="1808927785R3" style="height: 20px;" class="row-headers-background"><div class="row-header-wrapper" style="line-height: 20px">4</div></th><td class="s0"></td><td class="s2" dir="ltr">Profit Margin</td><td class="s3" dir="ltr">WITH sessions_unique AS (<br>  SELECT DISTINCT<br>    session_id,<br>    traffic_source<br>  FROM `prism-acquire.prism_acquire.sessions`<br>),<br><br>session_revenue_by_month AS ( <br>  SELECT DISTINCT<br>    session_id,<br>    transaction_id,<br>    DATE(EXTRACT(YEAR FROM date), EXTRACT(MONTH FROM date), 1) AS month,<br>    SUM(transaction_revenue) AS session_revenue<br>  FROM `prism-acquire.prism_acquire.transactions`<br>  <br>  GROUP BY session_id, transaction_id, month<br>),<br><br>transaction_profit AS (<br>  SELECT<br>    txnitem.transaction_id,<br>    (txnitem.item_quantity * (txnitem.item_price - cost.cost_of_item)) AS item_profit<br>  FROM `prism-acquire.prism_acquire.transactionsanditems` AS txnitem<br>  <br>  JOIN `prism-acquire.prism_acquire.product_costs` AS cost<br>    ON txnitem.item_id = cost.item_id<br>),<br><br>session_profit AS (<br>  SELECT DISTINCT<br>    srev.session_id,<br>    srev.month,<br>    srev.session_revenue,<br>    SUM(txnprof.item_profit) AS total_profit<br>  FROM session_revenue_by_month AS srev<br>  <br>  JOIN transaction_profit AS txnprof<br>    ON srev.transaction_id = txnprof.transaction_id<br>  <br>  GROUP BY srev.session_id, srev.month, srev.session_revenue<br>),<br><br>session_profit_with_source AS (<br>  SELECT DISTINCT<br>    sprof.session_id,<br>    sprof.month,<br>    sprof.session_revenue,<br>    sprof.total_profit,<br>    session.traffic_source<br>  FROM session_profit AS sprof<br>  <br>  JOIN `prism-acquire.prism_acquire.sessions` AS session<br>    ON sprof.session_id = session.session_id<br>)<br><br>SELECT<br>  month,<br>  traffic_source,<br>  ROUND(SUM(session_revenue), 2) AS total_revenue,<br>  ROUND(SUM(total_profit), 2) AS total_profit,<br>  ROUND(SAFE_DIVIDE(SUM(total_profit), SUM(session_revenue)), 2) AS profit_margin<br>FROM session_profit_with_source<br><br>GROUP BY month, traffic_source<br>ORDER BY month, total_revenue DESC;</td></tr><tr style="height: 20px"><th id="1808927785R4" style="height: 20px;" class="row-headers-background"><div class="row-header-wrapper" style="line-height: 20px">5</div></th><td class="s0"></td><td class="s1"></td><td class="s3"></td></tr><tr style="height: 20px"><th id="1808927785R5" style="height: 20px;" class="row-headers-background"><div class="row-header-wrapper" style="line-height: 20px">6</div></th><td class="s0"></td><td class="s2" dir="ltr">Retention Rate</td><td class="s3" dir="ltr">WITH FirstTxn AS (<br>  SELECT<br>    user_cookie_id,<br>    MIN(date) AS first_txn_date<br>  FROM `prism-acquire.prism_acquire.transactions`<br>  GROUP BY user_cookie_id<br>),<br><br>-- Users active in the PREVIOUS month (used for BOM)<br>CustomersBOM AS (<br>  SELECT DISTINCT<br>    user_cookie_id,<br>    DATE(EXTRACT(YEAR FROM DATE_ADD(date, INTERVAL 1 MONTH)), EXTRACT(MONTH FROM DATE_ADD(date, INTERVAL 1 MONTH)), 1) AS txn_month<br>  FROM `prism-acquire.prism_acquire.transactions`<br>),<br><br>-- Users active in the CURRENT month (used for EOM)<br>CustomersEOM AS (<br>  SELECT DISTINCT<br>    user_cookie_id,<br>    DATE(EXTRACT(YEAR FROM date), EXTRACT(MONTH FROM date), 1) AS txn_month<br>  FROM `prism-acquire.prism_acquire.transactions`<br>)<br><br>SELECT<br>  DATE(EXTRACT(YEAR FROM t.date), EXTRACT(MONTH FROM t.date), 1) AS txn_month,<br>  <br>  COUNT(DISTINCT t.user_cookie_id) AS distinct_user_count,<br><br>  COUNT(DISTINCT bom.user_cookie_id) AS BOM_user_count,<br>  <br>  COUNT(DISTINCT eom.user_cookie_id) AS EOM_user_count,<br><br>  COUNT(DISTINCT <br>    CASE<br>      WHEN DATE(EXTRACT(YEAR FROM ft.first_txn_date), EXTRACT(MONTH FROM ft.first_txn_date), 1) <br>        = DATE(EXTRACT(YEAR FROM t.date), EXTRACT(MONTH FROM t.date), 1)<br>      THEN t.user_cookie_id<br>    END) AS new_user_count,<br><br>  CASE <br>    WHEN COUNT(DISTINCT bom.user_cookie_id) &gt; 0 THEN<br>      SAFE_DIVIDE(<br>        COUNT(DISTINCT eom.user_cookie_id) <br>        - COUNT(DISTINCT CASE<br>            WHEN DATE(EXTRACT(YEAR FROM ft.first_txn_date), EXTRACT(MONTH FROM ft.first_txn_date), 1) <br>              = DATE(EXTRACT(YEAR FROM t.date), EXTRACT(MONTH FROM t.date), 1)<br>            THEN t.user_cookie_id<br>          END),<br>        COUNT(DISTINCT bom.user_cookie_id)<br>      )<br>    ELSE NULL<br>  END AS retention_rate<br><br>FROM `prism-acquire.prism_acquire.transactions` AS t<br><br>LEFT JOIN FirstTxn AS ft<br>  ON t.user_cookie_id = ft.user_cookie_id<br><br>LEFT JOIN CustomersBOM AS bom<br>  ON t.user_cookie_id = bom.user_cookie_id<br>  AND DATE(EXTRACT(YEAR FROM t.date), EXTRACT(MONTH FROM t.date), 1) = bom.txn_month<br><br>LEFT JOIN CustomersEOM AS eom<br>  ON t.user_cookie_id = eom.user_cookie_id<br>  AND DATE(EXTRACT(YEAR FROM t.date), EXTRACT(MONTH FROM t.date), 1) = eom.txn_month<br><br>GROUP BY txn_month<br>ORDER BY txn_month DESC;<br>&quot;</td></tr><tr style="height: 20px"><th id="1808927785R6" style="height: 20px;" class="row-headers-background"><div class="row-header-wrapper" style="line-height: 20px">7</div></th><td class="s0"></td><td class="s1"></td><td class="s3"></td></tr><tr style="height: 20px"><th id="1808927785R7" style="height: 20px;" class="row-headers-background"><div class="row-header-wrapper" style="line-height: 20px">8</div></th><td class="s0"></td><td class="s2" dir="ltr">Conversion rate</td><td class="s3" dir="ltr">-- Click data by month<br>WITH click AS (<br>  SELECT <br>    DATE_TRUNC(date, MONTH) AS month,<br>    SUM(google_clicks) AS google_clicks,<br>    SUM(COALESCE(meta_clicks, 0)) AS meta_clicks,<br>    SUM(rtbhouse_clicks) AS rtbhouse_clicks,<br>    SUM(google_clicks + COALESCE(meta_clicks, 0) + rtbhouse_clicks) AS total_clicks<br>  FROM `prism-acquire.prism_acquire.adplatform_data` <br>  WHERE date BETWEEN &#39;2022-01-01&#39; AND &#39;2024-01-01&#39;<br>  GROUP BY month<br>),<br><br>-- Orders by month<br>o AS (<br>  SELECT<br>    DATE_TRUNC(t.date, MONTH) AS month,<br>    COUNT(t.transaction_id) AS total_order,<br>    SUM(t.transaction_revenue) AS total_revenue,<br>    ROUND(SUM(t.transaction_revenue) / NULLIF(COUNT(t.transaction_id), 0), 2) AS AOV<br>  FROM `prism-acquire.prism_acquire.transactions` t<br>  WHERE t.date &gt;= &#39;2022-01-01&#39; AND t.date &lt; &#39;2024-01-01&#39;<br>  GROUP BY month<br>),<br><br>-- Registered vs Non-Registered orders by month<br>registration_status AS (<br>  SELECT<br>    DATE_TRUNC(t.date, MONTH) AS month,<br>    CASE WHEN u.user_crm_id IS NULL THEN &#39;Non-Registered&#39; ELSE &#39;Registered&#39; END AS user_status,<br>    COUNT(t.transaction_id) AS order_count<br>  FROM `prism-acquire.prism_acquire.transactions` t<br>  LEFT JOIN `prism-acquire.prism_acquire.users` u<br>    ON t.user_crm_id = u.user_crm_id<br>  WHERE t.date &gt;= &#39;2022-01-01&#39; AND t.date &lt; &#39;2024-01-01&#39;<br>  GROUP BY month, user_status<br>),<br><br>-- Aggregated registered breakdown<br>registration_pivot AS (<br>  SELECT<br>    month,<br>    SUM(CASE WHEN user_status = &#39;Registered&#39; THEN order_count ELSE 0 END) AS registered_order_count,<br>    SUM(CASE WHEN user_status = &#39;Non-Registered&#39; THEN order_count ELSE 0 END) AS non_registered_order_count<br>  FROM registration_status<br>  GROUP BY month<br>),<br><br>-- Main category item quantities per month<br>category_breakdown AS (<br>  SELECT<br>    DATE_TRUNC(t.date, MONTH) AS month,<br>    p.item_main_category,<br>    SUM(t.item_quantity) AS items_sold<br>  FROM `prism-acquire.prism_acquire.transactionsanditems` t<br>  LEFT JOIN `prism-acquire.prism_acquire.productattributes` p<br>    ON t.item_id = p.item_id<br>  WHERE t.date BETWEEN &#39;2022-01-01&#39; AND &#39;2024-01-01&#39;<br>  GROUP BY month, p.item_main_category<br>)<br><br>-- Final SELECT combines all<br>SELECT <br>  click.month,<br>  o.total_order,<br>  click.total_clicks,<br>  ROUND((o.total_order / NULLIF(click.total_clicks, 0)) * 100, 2) AS overall_conversion_rate,<br><br>  ROUND((o.total_order / NULLIF(click.google_clicks, 0)) * 100, 2) AS google_conversion_rate,<br>  ROUND((o.total_order / NULLIF(click.meta_clicks, 0)) * 100, 2) AS meta_conversion_rate,<br>  ROUND((o.total_order / NULLIF(click.rtbhouse_clicks, 0)) * 100, 2) AS rtbhouse_conversion_rate,<br><br>  rp.registered_order_count,<br>  rp.non_registered_order_count,<br>  ROUND((rp.registered_order_count / NULLIF(o.total_order, 0)) * 100, 2) AS registered_order_pct,<br>  ROUND((rp.non_registered_order_count / NULLIF(o.total_order, 0)) * 100, 2) AS non_registered_order_pct,<br><br>  cb.item_main_category,<br>  cb.items_sold<br><br>FROM click<br>LEFT JOIN o ON click.month = o.month<br>LEFT JOIN registration_pivot rp ON click.month = rp.month<br>LEFT JOIN category_breakdown cb ON click.month = cb.month<br>ORDER BY click.month, cb.items_sold DESC;<br></td></tr><tr style="height: 20px"><th id="1808927785R8" style="height: 20px;" class="row-headers-background"><div class="row-header-wrapper" style="line-height: 20px">9</div></th><td class="s0"></td><td class="s2 softmerge" dir="ltr"><div class="softmerge-inner" style="width:118px;left:-1px">Cost per Acquisition</div></td><td class="s3" dir="ltr">WITH adplatform_cost AS (  <br>  SELECT <br>    DATE_TRUNC(date, MONTH) AS month,<br>    SUM(google_cost) AS google_cost,<br>    SUM(meta_cost) AS meta_cost,<br>    SUM(rtbhouse_cost) AS rtbhouse_cost,<br>    ROUND(SUM(google_cost + COALESCE(meta_cost, 0) + rtbhouse_cost), 2) AS total_adplatform_cost<br>  FROM `prism-acquire.prism_acquire.adplatform_data`<br>  WHERE date &gt;= &#39;2022-01-01&#39; AND date &lt; &#39;2024-01-01&#39;<br>  GROUP BY month<br>),<br><br>new_customer AS (<br>  SELECT <br>    DATE_TRUNC(date, MONTH) AS month,<br>    COUNT(transaction_id) AS new_customer<br>  FROM `prism-acquire.prism_acquire.transactions`<br>  WHERE date &gt;= &#39;2022-01-01&#39; AND date &lt; &#39;2024-01-01&#39;<br>  GROUP BY month<br>),<br><br>registration_status AS (<br>  SELECT<br>    DATE_TRUNC(t.date, MONTH) AS month,<br>    CASE <br>      WHEN u.user_crm_id IS NULL THEN &#39;Non-Registered&#39;<br>      ELSE &#39;Registered&#39;<br>    END AS user_status,<br>    COUNT(t.transaction_id) AS customer_count<br>  FROM `prism-acquire.prism_acquire.transactions` t<br>  LEFT JOIN `prism-acquire.prism_acquire.users` u<br>    ON t.user_crm_id = u.user_crm_id<br>  WHERE t.date &gt;= &#39;2022-01-01&#39; AND t.date &lt; &#39;2024-01-01&#39;<br>  GROUP BY month, user_status<br>)<br><br>SELECT <br>  adplatform_cost.month,<br>  adplatform_cost.google_cost,<br>  adplatform_cost.meta_cost,<br>  adplatform_cost.rtbhouse_cost,<br>  adplatform_cost.total_adplatform_cost,<br>  MAX(new_customer.new_customer) AS new_customer,<br>  ROUND((adplatform_cost.total_adplatform_cost / NULLIF(MAX(new_customer.new_customer), 0)), 2) AS total_CAC,<br><br>  -- Registered / Non-Registered user breakdown<br>  MAX(CASE WHEN r.user_status = &#39;Registered&#39; THEN r.customer_count ELSE 0 END) AS registered_customers,<br>  MAX(CASE WHEN r.user_status = &#39;Non-Registered&#39; THEN r.customer_count ELSE 0 END) AS non_registered_customers<br><br>FROM adplatform_cost<br>LEFT JOIN new_customer <br>  ON adplatform_cost.month = new_customer.month<br>LEFT JOIN registration_status r<br>  ON adplatform_cost.month = r.month<br>GROUP BY <br>  adplatform_cost.month,<br>  adplatform_cost.google_cost,<br>  adplatform_cost.meta_cost,<br>  adplatform_cost.rtbhouse_cost,<br>  adplatform_cost.total_adplatform_cost<br>ORDER BY adplatform_cost.month ASC;<br></td></tr></tbody></table></div>